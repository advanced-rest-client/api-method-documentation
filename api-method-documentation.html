<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../raml-aware/raml-aware.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../api-annotation-document/api-annotation-document.html">
<link rel="import" href="../api-body-document/api-body-document.html">
<link rel="import" href="../api-parameters-document/api-parameters-document.html">
<link rel="import" href="../api-headers-document/api-headers-document.html">
<link rel="import" href="../api-responses-document/api-responses-document.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../marked-element/marked-element.html">

<dom-module id="api-method-documentation">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      display: block;
      padding-bottom: 24px;
      @apply --arc-font-body1;
      @apply --api-method-documentation;
    }

    [hidden] {
      display: none !important;
    }

    h1 {
      @apply --arc-font-headline;
      @apply --raml-docs-method-viewer-content-section;
    }

    h2 {
      @apply --arc-font-title;
      @apply --raml-docs-method-viewer-content-section;
    }

    .title-area {
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .title {
      @apply --layout-flex;
    }

    .method-name {
      font-weight: var(--raml-docs-method-viewer-title-method-font-weight, 500);
    }

    .url-area {
      @apply --layout-horizontal;
      @apply --arc-font-code1;
      font-size: 16px;
      margin-bottom: 40px;
      background: #424242;
      padding: 8px;
      color: #fff;
      border-radius: 2px;
      @apply --raml-docs-method-viewer-content-section;
    }

    .url-value {
      font-style: var(--raml-docs-method-viewer-url-font-style, italic);
      margin-left: 12px;
      word-break: break-all;

      @apply --raml-docs-method-viewer-url;
    }

    .method-value {
      text-transform: uppercase;
      font-weight: var(--raml-docs-method-viewer-http-method-font-weight, 500);
      white-space: nowrap;
    }

    .action-button {
      background-color: var(--primary-color);
      color: var(--primary-action-color, #fff);
      @apply --action-button;
    }

    .action-button:hover {
      @apply --action-button-hover;
    }

    .bottom.action {
      @apply --layout-horizontal;
      @apply --layout-end-justified;
    }

    marked-element {
      margin: 12px 0;
    }

    .markdown-body {
      margin-bottom: 28px;
      color: rgba(0, 0, 0, 0.74);
      @apply --arc-font-body1;
      @apply --raml-docs-method-viewer-content-section;
    }

    :host([narrow]) .title-area {
      margin-bottom: 24px;
    }

    :host([narrow]) h1 {
      font-size: 20px;
      margin: 0;
    }

    :host([narrow]) h2 {
      font-size: 18px;
    }

    :host([narrow]) h3 {
      font-size: 17px;
    }
    </style>
    <template is="dom-if" if="[[aware]]">
      <raml-aware raml="{{amfModel}}" scope="[[aware]]"></raml-aware>
    </template>
    <div class="title-area">
      <h1 class="title">
        <template is="dom-if" if="[[parentName]]">
          <span>[[parentName]]:</span>
        </template>
        <span class="method-name">[[methodName]]</span>
      </h1>
      <template is="dom-if" if="[[!noTryIt]]">
        <div class="action">
          <paper-button class="action-button" on-tap="_tryIt">Try it</paper-button>
        </div>
      </template>
    </div>

    <template is="dom-if" if="[[hasCustomProperties]]">
      <api-annotation-document shape="[[method]]"></api-annotation-document>
    </template>

    <template is="dom-if" if="[[description]]">
      <marked-element markdown="[[description]]">
        <div slot="markdown-html" class="markdown-body"></div>
      </marked-element>
    </template>

    <section class="request-documentation">
      <h2>Request</h2>

      <div class="url-area">
        <div class="method-value">[[httpMethod]]</div>
        <div class="url-value">[[endpointUri]]</div>
      </div>

      <template is="dom-if" if="[[hasParameters]]">
        <api-parameters-document amf-model="[[amfModel]]" query-opened base-uri-parameters="[[serverVariables]]" endpoint-parameters="[[endpointVariables]]" query-parameters="[[queryParameters]]"></api-parameters-document>
      </template>

      <template is="dom-if" if="[[hasHeaders]]">
        <api-headers-document opened amf-model="[[amfModel]]" headers="[[headers]]"></api-headers-document>
      </template>

      <template is="dom-if" if="[[hasPayload]]">
        <api-body-document amf-model="[[amfModel]]" body="[[payload]]" opened></api-body-document>
      </template>
    </section>

    <template is="dom-if" if="[[hasReturns]]">
      <section class="response-documentation">
        <h2>Response</h2>
        <api-responses-document amf-model="[[amfModel]]" returns="[[returns]]"></api-responses-document>
      </section>
    </template>

    <template is="dom-if" if="[[!noTryIt]]">
      <div class="bottom action">
        <paper-button class="action-button" on-tap="_tryIt">Try it</paper-button>
      </div>
    </template>
  </template>
  <script>
  /**
   * `api-method-documentation`
   *
   * Renders documentation for a method for an endpoint.
   *
   * This element works with [AMF](https://github.com/mulesoft/amf) data model.
   * To properly compute all the information relevant to method documentation
   * set the following properties:
   *
   * - amfModel - as AMF's WebApi data model
   * - endpoint - As AMF's EndPoint data model
   * - method - As AMF's SupportedOperation property
   *
   * When set, this will automatically populate the wiew with data.
   *
   * ## Updating API's base URI
   *
   * By default the component render the documentation as it is defined
   * in the AMF model. Sometimes, however, you may need to replace the base URI
   * of the API with something else. It is useful when the API does not
   * have base URI property defined (therefore this component render relative
   * paths instead of URIs) or when you want to manage different environments.
   *
   * To update base URI value either update `baseUri` property or use
   * `iron-meta` with key `ApiBaseUri`. First method is easier but the second
   * gives much more flexibility since it use a [monostate pattern](http://wiki.c2.com/?MonostatePattern)
   * to manage base URI property.
   *
   * When the component constructs the funal URI for the endpoint it does the following:
   * - if `baseUri` is set it uses this value as a base uri for the endpoint
   * - else if `iron-meta` with key `ApiBaseUri` exists and contains a value
   * it uses it uses this value as a base uri for the endpoint
   * - else if `amfModel` is set then it computes base uri value from main
   * model document
   * Then it concatenates computed base URI with `endpoint`'s path property.
   *
   * ### Example
   *
   * ```html
   * <iron-meta key="ApiBaseUri" value="https://domain.com"></iron-meta>
   * ```
   *
   * To update value of the `iron-meta`:
   * ```javascript
   * new Polymer.IronMeta({key: 'ApiBaseUri'}).value = 'https://other.domain';
   * ```
   *
   * Note: The element will not get notified about the change in `iron-meta`.
   * The change will be reflected whehn `amfModel` or `endpoint` property chnage.
   *
   * ## Styling
   *
   * `<api-method-documentation>` provides the following custom properties and mixins for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--api-method-documentation` | Mixin applied to this elment | `{}`
   *
   * @customElement
   * @polymer
   * @demo demo/index.html
   * @memberof ApiElements
   */
  class apiMethodDocumentation extends Polymer.Element {
    static get is() { return 'api-method-documentation'; }
    static get properties() {
      return {
        /**
         * `raml-aware` scope property to use.
         */
        aware: String,
        /**
         * Generated AMF json/ld model form the API spec.
         * The element assumes the object of the first array item to be a
         * type of `"http://raml.org/vocabularies/document#Document`
         * on AMF vocabulary.
         *
         * It is only usefult for the element to resolve references.
         *
         * @type {Object|Array}
         */
        amfModel: Object,
        /**
         * AMF method definition as a `http://www.w3.org/ns/hydra/core#supportedOperation`
         * object.
         */
        method: Object,
        /**
         * Method's endpoint definition as a
         * `http://raml.org/vocabularies/http#endpoint` of AMF model.
         */
        endpoint: Object,
        /**
         * The try it button is not rendered when set.
         */
        noTryIt: {
          type: Boolean,
          value: false
        },
        /**
         * Parent endpoint name.
         * It should be either a "displayName" or endpoint's relative
         * path.
         */
        parentName: {
          type: String,
          computed: '_computeEndpointName(endpoint)'
        },
        /**
         * Computed value from the method model, name of the method.
         * It is either a `displayName` or HTTP method name
         */
        methodName: {
          type: String,
          computed: '_computeMethodName(method)'
        },
        /**
         * HTTP method name string.
         *
         * It is computed from `endpoint`.
         */
        httpMethod: {
          type: String,
          computed: '_computeHttpMethod(method)'
        },
        /**
         * A property to set to override AMF's model base URI information.
         * When this property is set, the `endpointUri` property is recalculated.
         */
        baseUri: String,
        /**
         * Endpoint URI to display in main URL field.
         * This value is computed when `amfModel`, `endpoint` or `baseUri` change.
         */
        endpointUri: {
          type: String,
          computed: '_computeEndpointUri(server, endpoint, baseUri)'
        },
        /**
         * Computed value of method description from `method` property.
         */
        description: {
          type: String,
          computed: '_computeMethodDescription(method)'
        },
        /**
         * Computed value from current `method`. True if the model contains
         * custom properties (annotations in RAML).
         */
        hasCustomProperties: {
          type: Boolean,
          computed: '_computeHasCustomProperties(method)'
        },
        /**
         * Computed value of `http://www.w3.org/ns/hydra/core#expects`
         * of AMF model from current `method`
         */
        expects: {
          type: Object,
          computed: '_computeExpects(method)'
        },
        /**
         * Computed value of the `http://raml.org/vocabularies/http#server`
         * from `amfModel`
         */
        server: {
          type: Object,
          computed: '_computeServer(amfModel)'
        },
        /**
         * API base URI parameters defined in AMF api model
         *
         * @type {Array|undefined}
         */
        serverVariables: {
          type: Array,
          computed: '_computeServerVariables(server)'
        },
        /**
         * Endpoint's path parameters.
         *
         * @type {Array|undefined}
         */
        endpointVariables: {
          type: Array,
          computed: '_computeEndpointVariables(endpoint)'
        },
        /**
         * Computed value if server and endpoint definition of API model has
         * defined any variables.
         */
        hasPathParameters: {
          type: Boolean,
          computed: '_computeHasPathParameters(serverVariables, endpointVariables)'
        },
        /**
         * Computed value of method's query parameters.
         */
        queryParameters: {
          type: Array,
          computed: '_computeQueryParameters(expects)'
        },
        /**
         * Computed value if server definition of API model has defined
         * variables.
         */
        hasQueryParameters: {
          type: Boolean,
          computed: '_computeHasQueryParameters(queryParameters)'
        },
        /**
         * Computed value, true when either has path or query parameters.
         * This renders `api-parameters-document` if true.
         */
        hasParameters: {
          type: Boolean,
          computed: '_computeHasParameters(hasQueryParameters, hasPathParameters)'
        },
        /**
         * Computed value of AMF payload definition from `expects`
         * property.
         */
        payload: {
          type: Object,
          computed: '_computePayload(expects)'
        },
        /**
         * Computed value, true if `payload` has values.
         */
        hasPayload: {
          type: Boolean,
          computed: '_computeHasPayload(payload)'
        },
        /**
         * Computed value of AMF payload definition from `expects`
         * property.
         */
        headers: {
          type: Object,
          computed: '_computeHeaders(expects)'
        },
        /**
         * Computed value, true if `payload` has values.
         */
        hasHeaders: {
          type: Boolean,
          computed: '_computeHasHeaders(headers)'
        },
        /**
         * Computed value of AMF response definition from `returns`
         * property.
         */
        returns: {
          type: Object,
          computed: '_computeReturns(method)'
        },
        /**
         * Computed value, true if `returns` has values.
         */
        hasReturns: {
          type: Boolean,
          computed: '_computeHasReturns(returns)'
        },
        /**
         * Computed value of AMF security definition from `method`
         * property.
         */
        security: {
          type: Object,
          computed: '_computeSecurity(method)'
        },
        /**
         * Computed value, true if `returns` has values.
         */
        hasSecurity: {
          type: Boolean,
          computed: '_computeHasSecurity(security)'
        },
        /**
         * If set it will renders the view in the narrow layout.
         */
        narrow: {
          type: Boolean,
          reflectToAttribute: true
        }
      };
    }
    /**
     * Checks if property item has a type.
     * @param {Object} model Model item.
     * @param {String} type A type to lookup
     * @return {Boolean}
     */
    _hasType(model, type) {
      if (!model) {
        return false;
      }
      const types = model['@type'] || [];
      return types.findIndex((item) => item === type) !== -1;
    }
    /**
     * Gets a signle scalar value from a model.
     * @param {Object} model Amf model to extract the value from.
     * @param {String} key Model key to search for the value
     * @return {any} Value for key
     */
    _getValue(model, key) {
      let data = (model && model[key]);
      if (!data || !(data instanceof Array)) {
        return;
      }
      data = data[0];
      if (!data) {
        return;
      }
      return data['@value'];
    }
    /**
     * Computes value for `methodName` property.
     * It is either a `http://schema.org/name` or HTTP method name
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {String|undefined} Method friendly name
     */
    _computeMethodName(method) {
      if (this._hasType(method, 'http://www.w3.org/ns/hydra/core#Operation')) {
        let name = this._getValue(method, 'http://schema.org/name');
        if (!name) {
          name = this._getValue(method, 'http://www.w3.org/ns/hydra/core#method');
        }
        return name;
      }
    }
    /**
     * Computes value for `httpMethod` property.
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {String|undefined} HTTP method name
     */
    _computeHttpMethod(method) {
      if (this._hasType(method, 'http://www.w3.org/ns/hydra/core#Operation')) {
        return this._getValue(method, 'http://www.w3.org/ns/hydra/core#method');
      }
    }
    /**
     * Computes method's endpoint name.
     * It looks for `http://schema.org/name` in the endpoint definition and
     * if not found it uses path as name.
     *
     * @param {Object} endpoint Endpoint model.
     * @return {String} Endpoint name.
     */
    _computeEndpointName(endpoint) {
      if (this._hasType(endpoint, 'http://raml.org/vocabularies/http#EndPoint')) {
        let name = this._getValue(endpoint, 'http://schema.org/name');
        if (!name) {
          name = this._getValue(endpoint, 'http://raml.org/vocabularies/http#path');
        }
        return name;
      }
    }
    /**
     * Computes endpoint's URI based on `amfModel` and `endpoint` models.
     *
     * @param {Object} server Server model of AMF API.
     * @param {Object} endpoint Endpoint model
     * @param {?String} baseUri Current value of `baseUri` property
     * @return {String} Endpoint's URI
     */
    _computeEndpointUri(server, endpoint, baseUri) {
      let base = this._getBaseUri(baseUri, server);
      if (base && base[base.length - 1] === '/') {
        base = base.substr(0, base.length - 1);
      }
      const path = this._getValue(endpoint, 'http://raml.org/vocabularies/http#path');
      return base + (path || '');
    }
    /**
     * Computes base URI value from either `baseUri`, `iron-meta` with
     * `ApiBaseUri` key or `amfModel` value (in this order).
     *
     * @param {String} baseUri Value of `baseUri` property
     * @param {Object} server AMF API model for Server.
     * @return {String} Base uri value. Can be empty string.
     */
    _getBaseUri(baseUri, server) {
      if (baseUri) {
        return baseUri;
      }
      let value = new Polymer.IronMeta({key: 'ApiBaseUri'}).value;
      if (value) {
        return value;
      }
      return this._getAmfBaseUri(server) || '';
    }
    /**
     * Computes base URI from AMF model.
     *
     * @param {Object} server AMF API model for Server.
     * @return {String|undefined} Base uri value if exists.
     */
    _getAmfBaseUri(server) {
      return this._getValue(server, 'http://raml.org/vocabularies/http#url');
    }
    /**
     * Computes value for `server` property that is later used with other computations.
     *
     * @param {Array|Object} model AMF model for an API
     * @return {Object} The server model
     */
    _computeServer(model) {
      if (!model) {
        return;
      }
      if (model instanceof Array) {
        model = model[0];
      }
      const enc = model['http://raml.org/vocabularies/document#encodes'];
      if (!enc) {
        return;
      }
      const api = enc.find((item) => item['@type'] && item['@type'].indexOf('http://schema.org/WebAPI') !== -1);
      if (!api) {
        return;
      }
      const srv = api['http://raml.org/vocabularies/http#server'];
      return srv ? srv[0] : undefined;
    }
    /**
     * Computes value of `description` property.
     *
     * @param {Object} method SupportedOperation AMF model.
     * @return {String|undefined} Method description if defined.
     */
    _computeMethodDescription(method) {
      if (this._hasType(method, 'http://www.w3.org/ns/hydra/core#Operation')) {
        return this._getValue(method, 'http://schema.org/description');
      }
    }
    /**
     * Computes value for `hasCustomProperties` property.
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {Boolean}
     */
    _computeHasCustomProperties(method) {
      return (method && 'http://raml.org/vocabularies/document#customDomainProperties' in method);
    }
    /**
     * Computes value for the `expects` property.
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {Object}
     */
    _computeExpects(method) {
      if (this._hasType(method, 'http://www.w3.org/ns/hydra/core#Operation')) {
        const expects = method['http://www.w3.org/ns/hydra/core#expects'];
        if (expects) {
          return expects[0];
        }
      }
    }
    /**
     * Computes value for `hasPathParameters` property
     *
     * @param {?Array} sVars Current value of `serverVariables` property
     * @param {?Array} eVars Current value of `endpointVariables` property
     * @return {Boolean}
     */
    _computeHasPathParameters(sVars, eVars) {
      return !!((sVars && sVars.length) || (eVars && eVars.length));
    }
    /**
     * Computes value for `queryParameters` property
     *
     * @param {Object} expects SupportedOperation expects property
     * @return {Array<Object>|undefined} Parameetrs array
     */
    _computeQueryParameters(expects) {
      return expects && expects['http://raml.org/vocabularies/http#parameter'];
    }
    /**
     * Computes value for `hasQueryParameters` property.
     *
     * @param {?Array} params List of query parameters.
     * @return {Boolean}
     */
    _computeHasQueryParameters(params) {
      return !!(params && params.length);
    }
    /**
     * Computes value for `hasParameters` property.
     *
     * @param {Boolean} hasPath
     * @param {Boolean} hasQuery
     * @return {Boolean} True if any argument is true
     */
    _computeHasParameters(hasPath, hasQuery) {
      return !!(hasPath || hasQuery);
    }
    /**
     * Computes value for `serverVariables` property.
     *
     * @param {Object} server AMF API model for Server.
     * @return {Array<Object>|undefined} Variables if defined.
     */
    _computeServerVariables(server) {
      return server && server['http://raml.org/vocabularies/http#variable'];
    }
    /**
     * Computes value for `endpointVariables` property.
     *
     * @param {Object} endpoint Endpoint model
     * @return {Array<Object>|undefined} Parameters if defined.
     */
    _computeEndpointVariables(endpoint) {
      return endpoint && endpoint['http://raml.org/vocabularies/http#parameter'];
    }
    /**
     * Computes value for the `payload` property
     *
     * @param {Object} expects Current value of `expects` property.
     * @return {Array<Object>|undefined} Payload model if defined.
     */
    _computePayload(expects) {
      return expects && expects['http://raml.org/vocabularies/http#payload'];
    }
    /**
     * Computes value for `hasPayload` property
     *
     * @param {?Array<Object>} payload Current value of `payload` property
     * @return {Boolean}
     */
    _computeHasPayload(payload) {
      return !!(payload && payload.length);
    }
    /**
     * Computes value for the `headers` property
     *
     * @param {Object} expects Current value of `expects` property.
     * @return {Array<Object>|undefined} Headers model if defined.
     */
    _computeHeaders(expects) {
      return expects && expects['http://raml.org/vocabularies/http#header'];
    }
    /**
     * Computes value for `hasHeaders` property
     *
     * @param {?Array<Object>} headers Current value of `headers` property
     * @return {Boolean}
     */
    _computeHasHeaders(headers) {
      return !!(headers && headers.length);
    }
    /**
     * Computes value for `returns` property
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {Array<Object>|undefined}
     */
    _computeReturns(method) {
      return method && method['http://www.w3.org/ns/hydra/core#returns'];
    }
    /**
     * Computes value for `hasReturns` property.
     *
     * @param {?Array<Object>} returns Current value of `returns` property
     * @return {Boolean}
     */
    _computeHasReturns(returns) {
      return !!(returns && returns.length);
    }
    /**
     * Computes value for `security` property
     *
     * @param {Object} method AMF `supportedOperation` model
     * @return {Array<Object>|undefined}
     */
    _computeSecurity(method) {
      return method && method['http://raml.org/vocabularies/security#security'];
    }
    /**
     * Computes value for `hasSecurity` property.
     *
     * @param {?Array<Object>} security Current value of `security` property
     * @return {Boolean}
     */
    _computeHasSecurity(security) {
      return !!(security && security.length);
    }
    /**
     * "Try it" button click handler. Dispatches `tryit-requested` custom event
     */
    _tryIt() {
      this.dispatchEvent(new CustomEvent('tryit-requested', {
        bubbles: true
      }));
    }

    /**
     * Dispatched when the user requested the "Try it" view.
     * @event tryit-requested
     */
  }
  window.customElements.define(apiMethodDocumentation.is, apiMethodDocumentation);
  </script>
</dom-module>
